<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Lost & Found</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .detail-card { background: white; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); }
        .status-badge { padding: 0.5rem 1rem; border-radius: 25px; font-weight: 500; }
        .status-pending { background: #ffeaa7; color: #856404; }
        .status-under_review { background: #81ecec; color: #0984e3; }
        .status-approved { background: #55efc4; color: #00b894; }
        .status-rejected { background: #fab1a0; color: #d63031; }
        .status-withdrawn { background: #dfe6e9; color: #636e72; }
        .timeline-item { position: relative; padding-left: 30px; padding-bottom: 20px; border-left: 2px solid #dfe6e9; }
        .timeline-item:last-child { border-left: 2px solid transparent; }
        .timeline-dot { position: absolute; left: -8px; top: 0; width: 14px; height: 14px; border-radius: 50%; background: #6c5ce7; border: 2px solid white; }
        .item-image { width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; }
        .proof-image { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container py-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/claims/my-claims">My Claims</a></li>
                <li class="breadcrumb-item active">Claim Details</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Status Header -->
                <div class="detail-card p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h4 class="mb-1">Claim Request</h4>
                            <p class="text-muted mb-0">
                                Submitted on <%= new Date(claim.createdAt).toLocaleDateString('en-US', { 
                                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                                }) %>
                            </p>
                        </div>
                        <span class="status-badge status-<%= claim.status %>">
                            <% if (claim.status === 'pending') { %>
                                <i class="fas fa-hourglass-half me-1"></i>Pending Review
                            <% } else if (claim.status === 'under_review') { %>
                                <i class="fas fa-search me-1"></i>Under Review
                            <% } else if (claim.status === 'approved') { %>
                                <i class="fas fa-check-circle me-1"></i>Approved
                            <% } else if (claim.status === 'rejected') { %>
                                <i class="fas fa-times-circle me-1"></i>Rejected
                            <% } else { %>
                                <i class="fas fa-undo me-1"></i>Withdrawn
                            <% } %>
                        </span>
                    </div>

                    <% if (claim.status === 'rejected' && claim.rejectionReason) { %>
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-info-circle me-2"></i>Rejection Reason</h6>
                            <p class="mb-0"><%= claim.rejectionReason %></p>
                        </div>
                    <% } %>

                    <% if (claim.status === 'approved') { %>
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle me-2"></i>Claim Approved!</h6>
                            <p class="mb-0">Congratulations! Your claim has been approved. Please contact the admin to collect your item.</p>
                        </div>
                    <% } %>
                </div>

                <!-- Your Description -->
                <div class="detail-card p-4 mb-4">
                    <h5 class="mb-3"><i class="fas fa-comment-alt me-2 text-primary"></i>Your Description</h5>
                    <p class="mb-0"><%= claim.description %></p>
                </div>

                <!-- Proof of Ownership -->
                <div class="detail-card p-4 mb-4">
                    <h5 class="mb-3"><i class="fas fa-certificate me-2 text-success"></i>Proof of Ownership</h5>
                    <p><%= claim.proofOfOwnership %></p>

                    <% if (claim.identifyingFeatures) { %>
                        <h6 class="mt-4 mb-2">Identifying Features</h6>
                        <p class="mb-0"><%= claim.identifyingFeatures %></p>
                    <% } %>

                    <% if (claim.proofImages && claim.proofImages.length > 0) { %>
                        <h6 class="mt-4 mb-2">Uploaded Proof Images</h6>
                        <div class="d-flex gap-2 flex-wrap">
                            <% claim.proofImages.forEach(img => { %>
                                <img src="<%= img.url %>" class="proof-image" onclick="window.open('<%= img.url %>')">
                            <% }); %>
                        </div>
                    <% } %>
                </div>

                <!-- Timeline -->
                <div class="detail-card p-4">
                    <h5 class="mb-4"><i class="fas fa-history me-2 text-info"></i>Timeline</h5>
                    <div class="timeline">
                        <% if (claim.timeline && claim.timeline.length > 0) { %>
                            <% claim.timeline.slice().reverse().forEach(event => { %>
                                <div class="timeline-item">
                                    <div class="timeline-dot"></div>
                                    <div>
                                        <strong><%= event.action %></strong>
                                        <p class="text-muted small mb-0">
                                            <%= new Date(event.timestamp).toLocaleString() %>
                                            <% if (event.performedBy) { %>
                                                by <%= event.performedBy.username || 'System' %>
                                            <% } %>
                                        </p>
                                        <% if (event.note) { %>
                                            <p class="small mt-1 mb-0"><%= event.note %></p>
                                        <% } %>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="timeline-item">
                                <div class="timeline-dot"></div>
                                <div>
                                    <strong>Claim Submitted</strong>
                                    <p class="text-muted small mb-0"><%= new Date(claim.createdAt).toLocaleString() %></p>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Sidebar - Item Info -->
            <div class="col-lg-4">
                <div class="detail-card p-3 position-sticky" style="top: 80px;">
                    <h6 class="text-muted mb-3">
                        <i class="fas fa-box me-2"></i>Item Being Claimed
                    </h6>
                    
                    <% if (claim.item) { %>
                        <% if (claim.item.image) { %>
                            <img src="<%= claim.item.image %>" alt="" class="item-image mb-3">
                        <% } %>
                        
                        <h5><%= claim.item.title %></h5>
                        <p class="text-muted small mb-2">
                            <i class="fas fa-map-marker-alt me-1"></i><%= claim.item.location %>
                        </p>
                        <p class="small"><%= claim.item.description ? claim.item.description.substring(0, 150) + '...' : 'No description' %></p>
                        
                        <a href="/items/<%= claim.item._id %>" class="btn btn-outline-primary btn-sm w-100">
                            <i class="fas fa-external-link-alt me-1"></i>View Item
                        </a>
                    <% } else { %>
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-trash fa-2x mb-2"></i>
                            <p class="mb-0">Item has been deleted</p>
                        </div>
                    <% } %>

                    <hr>

                    <h6 class="text-muted mb-3">
                        <i class="fas fa-phone me-2"></i>Contact Details
                    </h6>
                    <p class="small mb-1">
                        <strong>Email:</strong> <%= claim.claimant.email %>
                    </p>
                    <% if (claim.contactPhone) { %>
                        <p class="small mb-1">
                            <strong>Phone:</strong> <%= claim.contactPhone %>
                        </p>
                    <% } %>
                    <p class="small mb-0">
                        <strong>Preferred:</strong> <%= claim.preferredContactMethod %>
                    </p>

                    <% if (['pending', 'under_review'].includes(claim.status)) { %>
                        <hr>
                        <form action="/claims/withdraw/<%= claim._id %>" method="POST" onsubmit="return confirm('Are you sure you want to withdraw this claim?')">
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="fas fa-times me-1"></i>Withdraw Claim
                            </button>
                        </form>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
