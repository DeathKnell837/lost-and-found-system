<%- contentFor('body') %>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="/admin/devices">Devices</a></li>
                    <li class="breadcrumb-item active">Device Details</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- Device Info Card -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <% if (device.device.type === 'mobile') { %>
                            <i class="fas fa-mobile-alt fa-4x text-primary"></i>
                        <% } else if (device.device.type === 'tablet') { %>
                            <i class="fas fa-tablet-alt fa-4x text-info"></i>
                        <% } else { %>
                            <i class="fas fa-desktop fa-4x text-secondary"></i>
                        <% } %>
                    </div>
                    <h4><%= device.device.vendor || 'Unknown' %> <%= device.device.model || device.device.type %></h4>
                    <p class="text-muted mb-0"><%= device.os.name %> <%= device.os.version %></p>
                    
                    <div class="mt-3">
                        <% if (device.isBlocked) { %>
                            <span class="badge bg-danger fs-6">Blocked</span>
                        <% } else if (device.isSuspicious) { %>
                            <span class="badge bg-warning text-dark fs-6">Suspicious</span>
                        <% } else { %>
                            <span class="badge bg-success fs-6">Active</span>
                        <% } %>
                    </div>
                </div>
                <hr class="my-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Fingerprint:</span>
                        <code class="small"><%= device.fingerprint.substring(0, 16) %>...</code>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Browser:</span>
                        <span><%= device.browser.name %> <%= device.browser.version %></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Total Visits:</span>
                        <span class="fw-bold"><%= device.visits %></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">First Seen:</span>
                        <span><%= new Date(device.firstSeen).toLocaleDateString() %></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Last Seen:</span>
                        <span><%= new Date(device.lastSeen).toLocaleDateString() %></span>
                    </div>
                </div>
                <hr class="my-0">
                <div class="card-body">
                    <% if (!device.isBlocked) { %>
                        <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#blockModal">
                            <i class="fas fa-ban me-2"></i>Block This Device
                        </button>
                    <% } else { %>
                        <form action="/admin/devices/<%= device._id %>/unblock" method="POST">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-check me-2"></i>Unblock Device
                            </button>
                        </form>
                    <% } %>
                </div>
            </div>

            <!-- User Agent -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h6 class="mb-0"><i class="fas fa-code me-2"></i>User Agent</h6>
                </div>
                <div class="card-body">
                    <code class="small text-break"><%= device.userAgent %></code>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-lg-8">
            <!-- IP Addresses -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-network-wired me-2"></i>IP Addresses (<%= device.ipAddresses ? device.ipAddresses.length : 0 %>)</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>IP Address</th>
                                <th>First Seen</th>
                                <th>Last Seen</th>
                                <th>Access Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (device.ipAddresses && device.ipAddresses.length > 0) { %>
                                <% device.ipAddresses.forEach(ip => { %>
                                <tr>
                                    <td><code><%= ip.ip %></code></td>
                                    <td><%= new Date(ip.firstSeen).toLocaleString() %></td>
                                    <td><%= new Date(ip.lastSeen).toLocaleString() %></td>
                                    <td><span class="badge bg-primary"><%= ip.count %></span></td>
                                </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-3">No IP addresses recorded</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Associated Users -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h6 class="mb-0"><i class="fas fa-users me-2"></i>Associated Users (<%= device.users ? device.users.length : 0 %>)</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>First Seen</th>
                                <th>Last Seen</th>
                                <th>Login Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (device.users && device.users.length > 0) { %>
                                <% device.users.forEach(u => { %>
                                <% if (u.user) { %>
                                <tr>
                                    <td>
                                        <a href="/admin/users?search=<%= u.user.username %>">
                                            <strong><%= u.user.username %></strong>
                                        </a>
                                        <% if (u.user.role === 'admin') { %>
                                            <span class="badge bg-danger ms-1">Admin</span>
                                        <% } %>
                                    </td>
                                    <td><%= u.user.email %></td>
                                    <td><%= new Date(u.firstSeen).toLocaleDateString() %></td>
                                    <td><%= new Date(u.lastSeen).toLocaleDateString() %></td>
                                    <td><span class="badge bg-info"><%= u.loginCount %></span></td>
                                </tr>
                                <% } %>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-3">No users associated with this device (Guest only)</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recent Pages Visited -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activity (Last 20 Pages)</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Page</th>
                                <th>Visited At</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (device.pages && device.pages.length > 0) { %>
                                <% device.pages.slice(-20).reverse().forEach(page => { %>
                                <tr>
                                    <td><code><%= page.path %></code></td>
                                    <td><%= new Date(page.visitedAt).toLocaleString() %></td>
                                </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="2" class="text-center text-muted py-3">No page history recorded</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <% if (blockedInfo) { %>
            <!-- Block Information -->
            <div class="card border-0 shadow-sm border-danger mb-4">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0"><i class="fas fa-ban me-2"></i>Block Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Blocked At:</strong> <%= new Date(blockedInfo.blockedAt).toLocaleString() %></p>
                            <p><strong>Blocked By:</strong> <%= blockedInfo.blockedBy ? blockedInfo.blockedBy.username : 'System' %></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Reason:</strong> <%= blockedInfo.reason %></p>
                            <p><strong>Access Attempts:</strong> <%= blockedInfo.accessAttempts %></p>
                        </div>
                    </div>
                    <% if (blockedInfo.blockHistory && blockedInfo.blockHistory.length > 0) { %>
                    <hr>
                    <h6>Block History</h6>
                    <ul class="list-unstyled">
                        <% blockedInfo.blockHistory.forEach(h => { %>
                        <li class="mb-1">
                            <span class="badge <%= h.action === 'blocked' ? 'bg-danger' : 'bg-success' %>"><%= h.action %></span>
                            <%= new Date(h.date).toLocaleString() %>
                            <% if (h.reason) { %> - <%= h.reason %><% } %>
                        </li>
                        <% }) %>
                    </ul>
                    <% } %>
                </div>
            </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Block Device Modal -->
<div class="modal fade" id="blockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/admin/devices/<%= device._id %>/block">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-ban me-2"></i>Block Device</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>You are about to block: <strong><%= device.device.vendor || 'Unknown' %> <%= device.device.model || device.device.type %></strong></p>
                    <div class="mb-3">
                        <label class="form-label">Reason for blocking <span class="text-danger">*</span></label>
                        <select name="reason" class="form-select" required>
                            <option value="">Select a reason...</option>
                            <option value="Spam or abuse">Spam or abuse</option>
                            <option value="Fake reports">Submitting fake reports</option>
                            <option value="Harassment">Harassment</option>
                            <option value="Terms violation">Terms of service violation</option>
                            <option value="Suspicious activity">Suspicious activity</option>
                            <option value="Multiple accounts">Multiple account abuse</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Additional Notes</label>
                        <textarea name="notes" class="form-control" rows="3" placeholder="Optional additional details..."></textarea>
                    </div>
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        This device will no longer be able to access the website.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-ban me-1"></i>Block Device
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
