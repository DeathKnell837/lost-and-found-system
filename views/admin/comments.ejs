<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <div class="d-flex">
        <%- include('../partials/admin-sidebar') %>

        <main class="flex-grow-1 p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="mb-1"><i class="fas fa-comments me-2"></i>Comment Moderation</h4>
                    <p class="text-muted mb-0">Manage and moderate user comments</p>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h3 class="mb-0"><%= counts.all %></h3>
                            <small class="text-muted">Total Comments</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm border-success">
                        <div class="card-body text-center">
                            <h3 class="mb-0 text-success"><%= counts.visible %></h3>
                            <small class="text-muted">Visible</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm border-danger">
                        <div class="card-body text-center">
                            <h3 class="mb-0 text-danger"><%= counts.hidden %></h3>
                            <small class="text-muted">Hidden</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm border-warning">
                        <div class="card-body text-center">
                            <h3 class="mb-0 text-warning"><%= counts.helpful %></h3>
                            <small class="text-muted">Helpful</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="btn-group">
                        <a href="/admin/comments" class="btn btn-<%= currentFilter === 'all' ? 'primary' : 'outline-primary' %>">All</a>
                        <a href="/admin/comments?filter=visible" class="btn btn-<%= currentFilter === 'visible' ? 'primary' : 'outline-primary' %>">Visible</a>
                        <a href="/admin/comments?filter=hidden" class="btn btn-<%= currentFilter === 'hidden' ? 'primary' : 'outline-primary' %>">Hidden</a>
                        <a href="/admin/comments?filter=helpful" class="btn btn-<%= currentFilter === 'helpful' ? 'primary' : 'outline-primary' %>">Helpful</a>
                    </div>
                </div>
            </div>

            <!-- Comments Table -->
            <div class="card border-0 shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Comment</th>
                                <th>Item</th>
                                <th>Author</th>
                                <th>Type</th>
                                <th>Stats</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (comments.length === 0) { %>
                                <tr>
                                    <td colspan="7" class="text-center py-5 text-muted">
                                        <i class="fas fa-comments fa-3x mb-3 d-block"></i>
                                        No comments found
                                    </td>
                                </tr>
                            <% } else { %>
                                <% comments.forEach(comment => { %>
                                    <tr class="<%= comment.isHidden ? 'table-danger' : '' %>">
                                        <td style="max-width: 300px;">
                                            <div class="text-truncate">
                                                <% if (comment.isPinned) { %>
                                                    <i class="fas fa-thumbtack text-primary me-1"></i>
                                                <% } %>
                                                <% if (comment.isHelpful) { %>
                                                    <i class="fas fa-star text-warning me-1"></i>
                                                <% } %>
                                                <%= comment.content %>
                                            </div>
                                            <% if (comment.isHidden) { %>
                                                <small class="text-danger">
                                                    <i class="fas fa-eye-slash me-1"></i>Hidden: <%= comment.hiddenReason || 'No reason' %>
                                                </small>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (comment.item) { %>
                                                <a href="/items/<%= comment.item._id %>" target="_blank" class="text-decoration-none">
                                                    <%= comment.item.title.substring(0, 20) %><%= comment.item.title.length > 20 ? '...' : '' %>
                                                </a>
                                            <% } else { %>
                                                <span class="text-muted">Deleted</span>
                                            <% } %>
                                        </td>
                                        <td><%= comment.author ? comment.author.username : 'Unknown' %></td>
                                        <td>
                                            <span class="badge bg-<%= comment.type === 'tip' ? 'success' : comment.type === 'question' ? 'info' : comment.type === 'update' ? 'warning' : 'secondary' %>">
                                                <%= comment.type %>
                                            </span>
                                        </td>
                                        <td>
                                            <small>
                                                <i class="fas fa-thumbs-up text-success"></i> <%= comment.helpfulVotes ? comment.helpfulVotes.length : 0 %>
                                                <i class="fas fa-reply text-info ms-2"></i> <%= comment.replies ? comment.replies.length : 0 %>
                                            </small>
                                        </td>
                                        <td>
                                            <small><%= new Date(comment.createdAt).toLocaleDateString() %></small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <% if (comment.isHidden) { %>
                                                    <button class="btn btn-outline-success" onclick="unhideComment('<%= comment._id %>')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                <% } else { %>
                                                    <button class="btn btn-outline-danger" onclick="hideComment('<%= comment._id %>')">
                                                        <i class="fas fa-eye-slash"></i>
                                                    </button>
                                                <% } %>
                                                <button class="btn btn-outline-primary" onclick="togglePin('<%= comment._id %>')">
                                                    <i class="fas fa-thumbtack"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Hide Modal -->
    <div class="modal fade" id="hideModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Hide Comment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">Reason for hiding</label>
                    <input type="text" id="hideReason" class="form-control" placeholder="Inappropriate content, spam, etc.">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmHide()">Hide Comment</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentCommentId = null;
        const hideModal = new bootstrap.Modal(document.getElementById('hideModal'));

        function hideComment(id) {
            currentCommentId = id;
            hideModal.show();
        }

        async function confirmHide() {
            const reason = document.getElementById('hideReason').value;
            try {
                const res = await fetch(`/admin/comments/${currentCommentId}/hide`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                if (res.ok) location.reload();
            } catch (err) {
                alert('Failed to hide comment');
            }
        }

        async function unhideComment(id) {
            if (!confirm('Restore this comment?')) return;
            try {
                const res = await fetch(`/admin/comments/${id}/unhide`, { method: 'POST' });
                if (res.ok) location.reload();
            } catch (err) {
                alert('Failed to restore comment');
            }
        }

        async function togglePin(id) {
            try {
                const res = await fetch(`/admin/comments/${id}/pin`, { method: 'POST' });
                if (res.ok) location.reload();
            } catch (err) {
                alert('Failed to toggle pin');
            }
        }
    </script>
</body>
</html>
