<div class="container py-5">
    <div class="row">
        <!-- Item Details -->
        <div class="col-lg-8">
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item">
                        <a href="/items/<%= item.type %>"><%= item.type === 'lost' ? 'Lost Items' : 'Found Items' %></a>
                    </li>
                    <li class="breadcrumb-item active"><%= item.itemName %></li>
                </ol>
            </nav>
            
            <div class="card shadow">
                <!-- Image -->
                <% if (item.imagePath) { %>
                    <img src="<%= item.imagePath %>" class="card-img-top item-detail-image" alt="<%= item.itemName %>">
                <% } else { %>
                    <div class="item-detail-placeholder d-flex align-items-center justify-content-center bg-light">
                        <i class="fas fa-image fa-5x text-muted"></i>
                    </div>
                <% } %>
                
                <div class="card-body">
                    <!-- Status Badges -->
                    <div class="d-flex gap-2 mb-3">
                        <span class="badge bg-<%= item.type === 'lost' ? 'danger' : 'success' %> fs-6">
                            <i class="fas fa-<%= item.type === 'lost' ? 'exclamation-triangle' : 'hand-holding-heart' %> me-1"></i>
                            <%= item.type.charAt(0).toUpperCase() + item.type.slice(1) %>
                        </span>
                        <span class="badge bg-<%= 
                            item.status === 'approved' ? 'primary' : 
                            item.status === 'pending' ? 'warning' : 
                            item.status === 'claimed' ? 'info' : 'secondary' 
                        %> fs-6">
                            <%= item.status.charAt(0).toUpperCase() + item.status.slice(1) %>
                        </span>
                        <% if (item.category) { %>
                            <span class="badge bg-secondary fs-6">
                                <i class="fas <%= item.category.icon || 'fa-box' %> me-1"></i>
                                <%= item.category.name %>
                            </span>
                        <% } %>
                    </div>
                    
                    <h2 class="card-title mb-3"><%= item.itemName %></h2>
                    
                    <!-- Info Grid -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center text-muted">
                                <i class="fas fa-map-marker-alt fa-fw me-2 text-danger"></i>
                                <div>
                                    <small class="d-block text-uppercase">Location</small>
                                    <strong class="item-value"><%= item.location %></strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center text-muted">
                                <i class="fas fa-calendar fa-fw me-2 text-primary"></i>
                                <div>
                                    <small class="d-block text-uppercase">Date <%= item.type === 'lost' ? 'Lost' : 'Found' %></small>
                                    <strong class="item-value">
                                        <%= new Date(item.dateLostFound).toLocaleDateString('en-US', { 
                                            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                                        }) %>
                                    </strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center text-muted">
                                <i class="fas fa-clock fa-fw me-2 text-info"></i>
                                <div>
                                    <small class="d-block text-uppercase">Date Reported</small>
                                    <strong class="item-value">
                                        <%= new Date(item.dateReported).toLocaleDateString('en-US', { 
                                            year: 'numeric', month: 'long', day: 'numeric' 
                                        }) %>
                                    </strong>
                                </div>
                            </div>
                        </div>
                        <% if (item.status === 'claimed' && item.claimedBy) { %>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center text-muted">
                                    <i class="fas fa-handshake fa-fw me-2 text-success"></i>
                                    <div>
                                        <small class="d-block text-uppercase">Claimed On</small>
                                        <strong class="item-value">
                                            <%= new Date(item.claimedBy.date).toLocaleDateString('en-US', { 
                                                year: 'numeric', month: 'long', day: 'numeric' 
                                            }) %>
                                        </strong>
                                    </div>
                                </div>
                            </div>
                        <% } %>
                    </div>
                    
                    <!-- Description -->
                    <h5><i class="fas fa-align-left me-2"></i> Description</h5>
                    <p class="lead"><%= item.description %></p>
                    
                    <!-- Comments Section -->
                    <hr class="my-4">
                    <h5><i class="fas fa-comments me-2"></i> Comments & Tips</h5>
                    
                    <% if (typeof user !== 'undefined' && user) { %>
                        <div class="mb-4">
                            <form id="commentForm" class="d-flex gap-2">
                                <select id="commentType" class="form-select" style="width: auto;">
                                    <option value="comment">üí¨ Comment</option>
                                    <option value="tip">üí° Tip</option>
                                    <option value="question">‚ùì Question</option>
                                </select>
                                <input type="text" id="commentContent" class="form-control" placeholder="Share a comment or tip..." required>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    <% } else { %>
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle me-2"></i>
                            <a href="/auth/login">Login</a> to leave a comment or tip.
                        </div>
                    <% } %>
                    
                    <div id="commentsContainer">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin"></i> Loading comments...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Contact Information -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-address-card me-2"></i> Contact Information</h5>
                </div>
                <div class="card-body">
                    <% if (item.status !== 'claimed') { %>
                        <div class="mb-3">
                            <label class="text-muted small">Reported By</label>
                            <p class="mb-0 fw-bold contact-value"><%= item.reporterName %></p>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Email</label>
                            <p class="mb-0">
                                <a href="mailto:<%= item.reporterEmail %>"><%= item.reporterEmail %></a>
                            </p>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Contact Info</label>
                            <p class="mb-0 contact-value"><%= item.contactInfo %></p>
                        </div>
                        <hr>
                        <a href="mailto:<%= item.reporterEmail %>?subject=Regarding: <%= item.itemName %>" 
                           class="btn btn-primary w-100">
                            <i class="fas fa-envelope me-2"></i> Contact Reporter
                        </a>
                    <% } else { %>
                        <div class="text-center text-muted">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <p>This item has been claimed and returned to its owner.</p>
                        </div>
                    <% } %>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="card shadow mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-share-alt me-2"></i> Share</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary flex-fill" onclick="shareOnFacebook()">
                            <i class="fab fa-facebook-f"></i>
                        </button>
                        <button class="btn btn-outline-info flex-fill" onclick="shareOnTwitter()">
                            <i class="fab fa-twitter"></i>
                        </button>
                        <button class="btn btn-outline-success flex-fill" onclick="shareOnWhatsApp()">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button class="btn btn-outline-secondary flex-fill" onclick="copyLink()">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card shadow mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <% if (item.type === 'found' && item.status === 'approved') { %>
                        <a href="/claims/form/<%= item._id %>" class="btn btn-success w-100 mb-2">
                            <i class="fas fa-hand-holding me-2"></i> Claim This Item
                        </a>
                    <% } %>
                    <a href="/posters/poster/<%= item._id %>" class="btn btn-outline-primary w-100 mb-2" target="_blank">
                        <i class="fas fa-print me-2"></i> Print Poster
                    </a>
                    <a href="/posters/mini/<%= item._id %>" class="btn btn-outline-secondary w-100 mb-2" target="_blank">
                        <i class="fas fa-file-alt me-2"></i> Print Mini Flyer
                    </a>
                    <button class="btn btn-outline-dark w-100" onclick="showQRCode()">
                        <i class="fas fa-qrcode me-2"></i> Show QR Code
                    </button>
                </div>
            </div>
            
            <!-- Related Items -->
            <% if (relatedItems && relatedItems.length > 0) { %>
                <div class="card shadow">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-th-large me-2"></i> Similar Items</h5>
                    </div>
                    <div class="card-body">
                        <% relatedItems.forEach(function(related) { %>
                            <div class="d-flex mb-3 pb-3 border-bottom">
                                <% if (related.imagePath) { %>
                                    <img src="<%= related.imagePath %>" class="related-item-img me-3" alt="<%= related.itemName %>">
                                <% } else { %>
                                    <div class="related-item-placeholder me-3 d-flex align-items-center justify-content-center bg-light">
                                        <i class="fas fa-image text-muted"></i>
                                    </div>
                                <% } %>
                                <div>
                                    <h6 class="mb-1">
                                        <a href="/items/<%= related._id %>" class="text-decoration-none">
                                            <%= related.itemName %>
                                        </a>
                                    </h6>
                                    <small class="text-muted">
                                        <span class="badge bg-<%= related.type === 'lost' ? 'danger' : 'success' %> me-1">
                                            <%= related.type %>
                                        </span>
                                        <%= related.location %>
                                    </small>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script>
const itemId = '<%= item._id %>';

function shareOnFacebook() {
    window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(window.location.href), '_blank');
}

function shareOnTwitter() {
    window.open('https://twitter.com/intent/tweet?url=' + encodeURIComponent(window.location.href) + '&text=' + encodeURIComponent('<%= item.type === "lost" ? "Lost" : "Found" %>: <%= item.itemName %>'), '_blank');
}

function shareOnWhatsApp() {
    window.open('https://wa.me/?text=' + encodeURIComponent('<%= item.type === "lost" ? "Lost" : "Found" %>: <%= item.itemName %> - ' + window.location.href), '_blank');
}

function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(() => {
        alert('Link copied to clipboard!');
    });
}

// QR Code Modal
async function showQRCode() {
    try {
        const res = await fetch(`/posters/qr/${itemId}`);
        const data = await res.json();
        if (data.success) {
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-qrcode me-2"></i>QR Code</h5>
                            <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${data.qrCode}" alt="QR Code" style="max-width: 250px;">
                            <p class="mt-3 text-muted small">Scan to view this item</p>
                        </div>
                        <div class="modal-footer">
                            <a href="${data.qrCode}" download="qr-code.png" class="btn btn-primary">
                                <i class="fas fa-download me-1"></i> Download
                            </a>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }
    } catch (err) {
        alert('Failed to generate QR code');
    }
}

// Comments Functionality
async function loadComments() {
    try {
        const res = await fetch(`/comments/item/${itemId}`);
        const data = await res.json();
        const container = document.getElementById('commentsContainer');
        
        if (data.comments.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-3"><i class="fas fa-comment-slash me-2"></i>No comments yet. Be the first to share!</p>';
            return;
        }
        
        container.innerHTML = data.comments.map(c => `
            <div class="card mb-2 ${c.isPinned ? 'border-primary' : ''}" id="comment-${c._id}">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            ${c.isPinned ? '<i class="fas fa-thumbtack text-primary me-1"></i>' : ''}
                            ${c.isHelpful ? '<i class="fas fa-star text-warning me-1"></i>' : ''}
                            <span class="badge bg-${c.type === 'tip' ? 'success' : c.type === 'question' ? 'info' : 'secondary'} me-2">
                                ${c.type === 'tip' ? 'üí°' : c.type === 'question' ? '‚ùì' : 'üí¨'}
                            </span>
                            <strong>${c.author?.username || 'User'}</strong>
                            <small class="text-muted ms-2">${new Date(c.createdAt).toLocaleDateString()}</small>
                            ${c.isEdited ? '<small class="text-muted ms-1">(edited)</small>' : ''}
                        </div>
                        <div>
                            <button class="btn btn-sm btn-link text-success p-0" onclick="voteHelpful('${c._id}')">
                                <i class="fas fa-thumbs-up"></i> <span>${c.helpfulVotes?.length || 0}</span>
                            </button>
                        </div>
                    </div>
                    <p class="mb-1 mt-2">${c.content}</p>
                    ${c.replies?.length ? `
                        <div class="ms-4 mt-2 border-start ps-3">
                            ${c.replies.map(r => `
                                <div class="small mb-1">
                                    <strong>${r.author?.username || 'User'}:</strong> ${r.content}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
        `).join('');
    } catch (err) {
        document.getElementById('commentsContainer').innerHTML = '<p class="text-muted">Failed to load comments</p>';
    }
}

async function voteHelpful(commentId) {
    try {
        const res = await fetch(`/comments/${commentId}/helpful`, { method: 'POST' });
        const data = await res.json();
        if (data.success) loadComments();
        else if (res.status === 401) window.location.href = '/auth/login';
    } catch (err) {
        console.error(err);
    }
}

// Submit comment
document.getElementById('commentForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const content = document.getElementById('commentContent').value;
    const type = document.getElementById('commentType').value;
    
    try {
        const res = await fetch(`/comments/item/${itemId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content, type })
        });
        
        if (res.ok) {
            document.getElementById('commentContent').value = '';
            loadComments();
        } else if (res.status === 401) {
            window.location.href = '/auth/login';
        }
    } catch (err) {
        alert('Failed to post comment');
    }
});

// Load comments on page load
document.addEventListener('DOMContentLoaded', loadComments);
</script>
